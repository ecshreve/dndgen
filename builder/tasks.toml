[[task]]
  id = "dev"
  description = "Start the dev server"
  dependencies = ["backend", "frontend", "describe"]
  type = "long"
  cmd = """
    echo "Starting the dev server..."
    while true; do
      sleep 1
    done
  """

[[task]]
  id = "backend"
  description = "Start the backend"
  watch = ["server/**/*.go"]
  dependencies = ["gqlgen"]
  type = "long"
  cmd = """
    echo "Starting the gql server..."
    go run -mod=mod ./server/main.go
  """

[[task]]
  id = "frontend"
  description = "Run the frontend"
  type = "long"
  dependencies = ["backend", "tsgen"]
  cmd = """
    echo "Starting the frontend..."
    cd frontend && npm start
  """

# ------------------------------------------------------------------------------
# code generation
# ------------------------------------------------------------------------------
[[task]]
  id = "entgen"
  description = "Generate ent schema"
  type = "short"
  watch = ["ent/schema/*.go"]
  cmd = """
    echo "Running ent generation with entc DIRECTLY..."
    go run -mod=mod ./ent/entc.go
  """

[[task]]
  id = "gqlgen"
  description = "Generate with gqlgen"
  triggers = ["entgen"]
  type = "short"
  cmd = """
    echo "Generating with gqlgen..."
    go run -mod=mod github.com/99designs/gqlgen generate
  """

[[task]]
  id = "tsgen"
  description = "Generate with gqlgen and typescript types"
  type = "short"
  triggers = ["gqlgen"]
  dependencies = ["backend"]
  cmd = """
    echo "Generating typescript types..."
    cd frontend && npm run compile
  """

# ------------------------------------------------------------------------------
# seeders
# ------------------------------------------------------------------------------
[[task]]
  id = "seeder"
  description = "Seed the database"
  type = "short"
  cmd = """
    echo "Deleting the database..."
    rm -f dev.db

    echo "Seeding the database..."
    go run -mod=mod ./cmd/seeder/main.go 
  """

[[task]]
  id = "seedgen"
  description = "Generate seeders"
  dependencies = ["entgen"]
  type = "short"
  cmd = """
    echo "Generating seeders..."
    go run -mod=mod ./internal/seeder/gen.go
  """
  
# ------------------------------------------------------------------------------
# db
# ------------------------------------------------------------------------------
[[task]]
  id = "db-apply"
  type = "short"
  cmd = """
  atlas migrate apply \
    --dir "file://ent/migrate/migrations" \
    --url "sqlite://prod.db?_fk=1"
  """

[[task]]
  id = "db-diff"
  type = "short"
  dependencies = ["db-lint"]
  cmd = """
  go run -mod=mod ent/migrate/main.go manual_mig
  """

[[task]]
  id = "db-lint"
  type = "short"
  dependencies = ["db-validate"]
  cmd = """
  atlas migrate lint \
    --dir "file://ent/migrate/migrations" \
    --dev-url "sqlite://dev?mode=memory&_fk=1" \
    --latest 1
  """

[[task]]
  id = "db-validate"
  type = "short"
  cmd = """
  atlas migrate validate \
    --dir "file://ent/migrate/migrations" \
    --dev-url "sqlite://dev?mode=memory&_fk=1" 
  """

# ------------------------------------------------------------------------------
# visualisation
# ------------------------------------------------------------------------------
[[task]]
  id = "describe"
  description = "Describe the schema"
  type = "short"
  triggers = ["entgen"]
  cmd = """
    echo "Describing the schema..."
    go run -mod=mod entgo.io/ent/cmd/ent describe ./ent/schema > ./entschema.md
  """