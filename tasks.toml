[[task]]
  id = "dev"
  description = "Run dev server"
  type = "long"
  dependencies = ["gqlserve", "popdev", "gen"]
  cmd = """
    echo "Running dev server..."
  """

# ------------------------------------------------------------------------------
#     Dev Commands
# -----------------------------------------------------------------------------

[[task]]
  id = "popdev"
  description = "Run the Popper populators"
  type = "short"
  cmd = """
    echo "Running popper..."
    go run -mod=mod internal/popper/main.go
  """

[[task]]
  id = "gqlserve"
  description = "Run the gqlserver"
  type = "short"
  triggers = ["entvizfix", "popdev"]
  cmd = """
    echo "Running gqlserver..."
    go run -mod=mod cmd/gqlserver/main.go
  """

# ------------------------------------------------------------------------------
#     Code Generation
# ------------------------------------------------------------------------------

[[task]]
  id = "gen"
  description = "Run all code generation"
  type = "group"
  dependencies = ["entgen", "gqlgen", "popgen"]

[[task]]
  id = "entgen"
  description = "Generate ent schema"
  type = "short"
  watch = ["ent/schema/*.go", "ent/entc.go", "gqlgen.yml"]
  cmd = """
    echo "Running ent generation with entc..."
    go run -mod=mod ent/entc.go
  """

[[task]]
  id = "gqlgen"
  description = "Generate graphql"
  type = "short"
  watch = ["gqlgen.yml"]
  dependencies = ["entgen"]
  cmd = """
    echo "Running gqlgen generation with gqlgen..."
    go run -mod=mod github.com/99designs/gqlgen
  """

[[task]]
  id = "popgen"
  description = "Generate the Popper populators"
  type = "short"
  watch = ["internal/popper/gen.go"]
  dependencies = ["entgen"]
  cmd = """
    echo "Running popper generation with go generate..."
    go generate ./internal/popper/...
  """

# ------------------------------------------------------------------------------
#     Database Operations
# ------------------------------------------------------------------------------
[[task]]
  id = "plan"
  description = "Generate database migration files"
  type = "short"
  cmd = """
    echo "Planning migrations..."
    go run -mod=mod ent/migrate/main.go seed
  """

[[task]]
  id = "db-hash"
  type = "short"
  cmd = """
  atlas migrate hash \
    --dir "file://ent/migrate/migrations"
  """

[[task]]
  id = "db-diff"
  type = "short"
  cmd = """
  atlas migrate diff manual \
    --dir "file://ent/migrate/migrations" \
    --to "ent://ent/schema?globalid=1" \
    --dev-url "sqlite://dev.db?mode=memory&_fk=1"
  """

[[task]]
  id = "db-lint"
  type = "short"
  cmd = """
  atlas migrate lint \
    --dir "file://ent/migrate/migrations" \
    --dev-url "sqlite://dev.db?mode=memory&_fk=1" \
    --latest 1
  """

[[task]]
  id = "db-validate"
  type = "short"
  cmd = """
  atlas migrate validate \
    --dir "file://ent/migrate/migrations" \
    --dev-url "sqlite://dev.db?mode=memory&_fk=1" 
  """

[[task]]
  id = "migrate"
  type = "short"
  description = "clean schema and apply database migrations to dev database"
  dependencies = ["db-clean"]
  cmd = """
  atlas migrate apply \
    --dir "file://ent/migrate/migrations" \
    --url "sqlite://dev.db?cache=shared&_fk=1" 
  """

[[task]]
  id = "db-clean"
  type = "short"
  dependencies = ["db-backup"]
  cmd = """
  atlas schema clean \
    --url "sqlite://dev.db?cache=shared&_fk=1" \
    --auto-approve
  """

[[task]]
  id = "db-backup"
  description = "Backup database"
  type = "short"
  dependencies = ["db-lint", "db-validate"]
  cmd = """
    echo "backing up database..."
    cp dev.db backup.db.bak
  """

# ------------------------------------------------------------------------------
#     Miscelaneous
# ------------------------------------------------------------------------------

[[task]]
  id = "entvizfix"
  description = "Fix entviz html"
  type = "short"
  triggers = ["entgen"]
  cmd = """
    echo "Fixing entviz html..."
    sed -i 's/widthConstraint: 60/widthConstraint: 120/g' ent/schema-viz.html
    sed -i 's/heightConstraint: 60/heightConstraint: 40/g' ent/schema-viz.html
    sed -i '/hierarchical: {/,/levelSeparation: 250,/ { 
  s/enabled: true,/enabled: false,/
  s/levelSeparation: 250,/levelSeparation: 100,/
}' ent/schema-viz.html
  """

[[task]]
  id = "test"
  description = "Run tests"
  type = "short"
  cmd = """
    echo "Running tests..."
    go test ./...
  """

[[task]]
  id = "snaps"
  description = "Update snapshots"
  type = "short"
  cmd = """
    echo "Updating snapshots..."
    go test ./... -rewriteSnapshots
  """